<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../soso-text-input/soso-text-input.html">
<link rel="import" href="../soso-file-picker/soso-file-picker.html">

<dom-module id="card-video-composer">
  <template>
    <style is="custom-style">
      .container {
        max-width: 600px;
        margin: 25px auto;
        padding: 15px;
      }

      soso-text-input {
        margin: 25px 0;
      }

      soso-file-picker {
        height: 100px;
      }

      #pickerPanel {
        position: relative;
      }

      #progress {
        position: absolute;
        top: 2px;
        left: 2px;
        padding: 5px;
        background-color: #FFF59D;
        font-size: 16px;
      }

      #videoPanel {
        max-width: 800px;
        width: 100%;
        position: relative;
      }

      video {
        width: 100%;
        height: auto;
      }

      .offscreen {
        position: fixed;
        left: 2000px;
        border: 1px solid black;
      }

      #uploadingThumbnail {
        position: absolute;
        top: 0;
        left: 0;
        padding: 5px;
        background-color: #FFF59D;
        font-size: 16px;
      }

      .seekExplain {
        font-size: 14px;
        font-style: italic;
      }
    </style>
    <div class="container">
      <div id="pickerPanel">
        <soso-file-picker id="filePicker" label="Drag an mp4 video file" accept=".mp4" on-files="_onFile"></soso-file-picker>
        <div id="progress" style="display:none;">
          <div>uploading...</div>
        </div>
      </div>
      <div id="videoPanel" style="display:none;">
        <video id="video" controls src="[[_videoUrl]]" crossorigin="anonymous"></video>
        <div id="uploadingThumbnail" style="display:none;">uploading thumbnail...</div>
        <div class="seekExplain">Seek to frame to use as card image</div>
      </div>
      <div>
        <soso-text-input id="title" label="Title"></soso-text-input>
        <soso-text-input id="description" label="Description"></soso-text-input>
      </div>
      <div class="offscreen">
        <canvas id="canvas"></canvas>
      </div>
    </div>
  </template>
  <script>
    class CardVideoComposer extends Polymer.Element {
      static get is() { return 'card-video-composer'; }
      static get properties() {
        return {
          services: Object,
          author: Object,
          _videoUrl: String
        };
      }
      connectedCallback() {
        super.connectedCallback();
        this._ready = false;
      }

      get isReady() {
        return this._ready;
      }

      prepare() {
        return new Promise((resolve, reject) => {
          this.$.canvas.width = this.$.video.offsetWidth;
          this.$.canvas.height = this.$.video.offsetHeight;
          this._thumbnailInProgress = true;
          this.$.uploadingThumbnail.style.display = "";
          setTimeout(() => {
            var context = this.$.canvas.getContext('2d');
            context.drawImage(this.$.video, 0, 0, this.$.video.offsetWidth, this.$.video.offsetHeight);
            this.services.upload(this.$.canvas.toDataURL()).then((response) => {
              this.$.uploadingThumbnail.style.display = "none";
              this._thumbnailUrl = response.url;
              this._thumbnailInProgress = false;
              resolve();
            }).catch((err) => {
              this._thumbnailInProgress = false;
              reject(err);
            });
          }, 25); // delay so don't do this too often
        });
      }

      get summary() {
        return {
          imageURL: this._thumbnailUrl,
          title: this.$.title.value.trim(),
          text: this.$.description.value.trim()
        };
      }

      get sharedState() {
        return {
          properties: {
            videoUrl: this._videoUrl,
            thumbnailUrl: this._thumbnailUrl,
            title: this.$.title.value.trim(),
            description: this.$.description.value.trim()
          },
          collections: {}
        }
      }

      _onFile(event) {
        this._file = event.detail.file;
        this.$.progress.style.display = "";
        this.services.upload(event.detail.file).then((response) => {
          this.set('_videoUrl', response.url);
          this.$.progress.style.display = "none";
          this.$.pickerPanel.style.display = "none";
          this.$.videoPanel.style.display = "";
          this._setReady(true);
        }).catch((err) => {
          this.$.filePicker.clear();
          this.$.progress.style.display = "none";
          this._file = null;
          this._videoUrl = null;
          this._setReady(false);
          console.error(err);
          this._setError("Failed to load video file");
        });
      }

      _setReady(value) {
        if (value !== this._ready) {
          this._ready = value;
          this.dispatchEvent(new CustomEvent('state-ready-change', { bubbles: true, composed: true, detail: { ready: this._ready } }));
        }
      }
    }
    window.customElements.define(CardVideoComposer.is, CardVideoComposer);
  </script>
</dom-module>

<dom-module id="card-video-viewer">
  <template>
    <style>
      .container {
        max-width: 800px;
        width: 100%;
      }

      video {
        width: 100%;
        height: auto;
      }

      .text {
        padding: 5px 15px;
      }
    </style>
    <div class="container">
      <div style="text-align:center;">
        <video id="v" controls autoplay src="[[sharedState.properties.videoUrl]]" poster="[[sharedState.properties.thumbnailUrl]]"></video>
      </div>
      <div class="text">
        <h2>[[sharedState.properties.title]]</h2>
        <p>[[sharedState.properties.description]]</p>
      </div>
    </div>

  </template>
  <script>
    class CardVideoViewer extends Polymer.Element {
      static get is() { return 'card-video-viewer'; }
      static get properties() {
        return {
          sharedState: Object,
          author: Object,
          user: Object
        };
      }
      connectedCallback() {
        super.connectedCallback();
      }
    }
    window.customElements.define(CardVideoViewer.is, CardVideoViewer);
  </script>
</dom-module>